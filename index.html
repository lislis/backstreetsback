<html>
  <head>
    <!-- <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script> -->
    <script src="a-frame-dev.js"></script>

    <script src="TinyMusic.js"></script>
    <script>
     // game state
     window.state = {
       current: 1,
       speed: 0.025,
       score: 0,
       mode: 'title',
       checkpoints: []
     }

     fetch('checkpoints.txt')
       .then((data) => data.json())
       .then((data) => {
         window.state.checkpoints = JSON.parse(data);
       })


     AFRAME.registerShader('brix', {
       schema: {},
       vertexShader: `
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
       `,
       fragmentShader: `
varying vec2 vUv;

void main() {
  float single = (mod(vUv[0], 0.09) * 60.0) * mod(vUv[1], 0.06) * 100.0;
  vec3 construct = vec3(single);

  construct.b = 0.3 * construct.r;
  construct.g = 0.3 * construct.r;

  gl_FragColor = vec4(construct, 1.0);
  //gl_FragColor = vec4(0.4, 0.2, 0.2, 1.0);
}
       `
     });

     AFRAME.registerComponent('cursor-listener', {
       init: function () {
         // Prep the speech synthesis voice
         var synth = window.speechSynthesis;
         var voice = synth.getVoices()[1];
         var otherVoice = synth.getVoices()[1];

         this.el.addEventListener('click', function (evt) {
           if (window.state.mode === 'play') {
             console.log(window.state)
             this.setAttribute('material', 'color', 'white');
             this.setAttribute('animation', 'property: rotation; to: 0 0 180; loop: false; dur: 800;');
             var utterThis = new SpeechSynthesisUtterance(this.getAttribute('text')['value']);
             utterThis.voice = voice;
             synth.speak(utterThis);
           }
         });

         this.el.addEventListener('animationcomplete', function (evt) {
           if (window.state.mode === 'play' ) {
             this.remove();
             var utterPoint = new SpeechSynthesisUtterance('Yeah!');
             utterPoint.voice = otherVoice;
             synth.speak(utterPoint);
             window.state.score ++;
             document.querySelector("#score-card").setAttribute('text', 'value', `${window.state.score}/10`);
             document.querySelector('#score-hud').setAttribute('text', 'value', `score ${window.state.score}`);
           }
         });
       }
     });

     AFRAME.registerComponent('title-plane', {
       init: function () {
         var synth = window.speechSynthesis;
         var voice = synth.getVoices()[2];
         this.el.setAttribute('animation', 'property: scale; from: 0.7 0.7 0.7; to: 1 1 1; loop: true; dir: alternate; dur: 800;');
         this.el.addEventListener('click', function (evt) {
           this.setAttribute('animation', 'property: rotation; to: 0 0 180; dir: normal; dur: 1000; loop: 1;');
           var utterThis = new SpeechSynthesisUtterance(this.getAttribute('text')['value']);
           utterThis.voice = voice;
           synth.speak(utterThis);
         });
         this.el.addEventListener('animationcomplete', function (evt) {
           this.parentNode.remove();
           window.state.mode = 'play';
         });
       }
     });

     AFRAME.registerComponent('end-plane', {
       init: function () {
         this.el.setAttribute('animation', 'property: scale; from: 0.7 0.7 0.7; to: 1 1 1; loop: true; dir: alternate; dur: 800;');
         this.el.addEventListener('click', function (evt) {
           window.location.reload();
         });
       }
     });

     AFRAME.registerComponent('player-auto-move', {
       init: function () {
         console.log('init player');
       },
       tick: function () {
         if (window.state.mode === 'play') {
           let current = window.state.checkpoints[state.current];

           if (current) {
             let checked = this.checkAxis(current);
             if (checked) {
               window.state.current += 1;
             }
           } else {
             window.state.mode = 'end';
           }
         }
       },

       checkAxis: function (current) {
         let axis = current.a;
         let pos = current.p;
         let player_ax = this.el.object3D.position[axis];
         let goal_ax = pos[axis];

         if (player_ax <= goal_ax) {
           this.el.object3D.position[axis] += state.speed;
         } else if (player_ax >= goal_ax) {
           this.el.object3D.position[axis] -= state.speed;
         }

         if (this.el.object3D.position[axis].toFixed(2) == goal_ax) {
           return true;
         } else {
           return false;
         }
       }
     });


     AFRAME.registerComponent('scene-play-music', {
       schema: {},
       init: function() {
         // TinyMusic action!
         var ac = new AudioContext();
         var tempo = 120;

         // https://tabs.ultimate-guitar.com/tab/backstreet_boys/everybody_backstreets_back_tabs_2427811
         // rests are gut feeling ¯\_(ツ)_/¯
         var sequence = new TinyMusic.Sequence( ac, tempo, [
           'B3 e',
           '- e',
           'B3 e',
           'A#3 e',
           'A3 e',
           'G#3 e',
           'G3 e',
           '- e',
           'G3 e',
           '- e',
           'G3 e',
           'A3 e',
           'F#3 e',
           '- h'
         ]);

         sequence.waveType = 'sine';
         sequence.staccato = 0.05;
         sequence.bass.gain.value = 30;
         sequence.mid.gain.value = 5;
         sequence.loop = true ;
         sequence.gain.gain.value =  0.2;
         sequence.play(); // and never stop!
       }

     });

    </script>
  </head>
  <body>
    <a-scene id="mainscene" scene-play-music>

      <a-entity id="title" geometry="primitive: plane; height: 3; width: 3" rotation="0 -90 0" position="-12 1.5 -10" material="color: black">
        <a-entity position="0 0.5 0" text="value: Backstreet's back; width: 5;align: center; font: monoid;"></a-entity>
        <a-entity title-plane
                  geometry="primitive: plane; width: 2; height: 1;"
                  material="color: grey"
                  position="0 -0.2 0.2"
                  text="value: Alright!; width: 6; height: 2; align: center; font: monoid; color: white;"></a-entity>
      </a-entity>

      <a-entity id="walls" position="0 0 0">
        <a-entity  position="-8 4 -12" geometry="primitive: box; width: 13; height: 8" material="shader: brix"></a-entity>
        <a-entity  position="-2 4 -8" geometry="primitive: box; width: 15; height: 8" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-12 7 -4" geometry="width: 8; height: 15; depth: 12" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-12 4 4" geometry="width: 15; height: 8" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-5 4 11" geometry="width: 15; height: 8" rotation="" material="shader: brix"></a-entity>
        <a-entity position="-2 10.85 12" geometry="width: 8; height: 22; depth: 12" rotation="" material="shader: brix"></a-entity>
        <a-entity position="4 4 11" geometry="width: 15; height: 8" rotation="" material="shader: brix"></a-entity>
        <a-entity position="1.4 6 0" geometry="width: 8; height: 14; depth: 5" rotation="" material="shader: brix"></a-entity>
        <a-entity position="11 4 0" geometry="width: 23; height: 8" rotation="0 90 0" material="shader: brix"></a-entity>
        <a-entity position="7 10 -11" geometry="width: 10; height: 22; depth: 12" rotation="" material="shader: brix"></a-entity>
      </a-entity>

      <a-entity position="-14 1.6 -10" rotation="0 -90 0" id="player" player-auto-move>
        <a-entity camera look-controls >
          <a-entity id="score-hud"
                    text="value: score 0; width: 2; height: 1; font: monoid; align: right; color: black" position="0.0 0.5 -0.7" rotation="0 0 0"></a-entity>
          <a-entity cursor="fuse: true; fuseTimeout: 500"
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: black; shader: flat"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity id="end" geometry="primitive: plane; height: 4; width: 3" rotation="0 0 0" position="0 1.5 -16" material="color: black">
        <a-entity id="score-card" position="0 1 0" text="value: 0/10; width: 5;align: center; font: monoid;"></a-entity>
        <a-entity position="0 0.4 0" text="value: Back again?; width: 5;align: center; font: monoid;"></a-entity>
        <a-entity end-plane
                  geometry="primitive: plane; width: 2; height: 1;"
                  material="color: grey"
                  position="0 -0.5 0.2"
                  text="value: Go to start!; width: 6; height: 2; align: center; font: monoid; color: white;"></a-entity>
      </a-entity>
      <a-plane id="floor" position="0 0 0" rotation="-90 0 0" width="30" height="30" material="shader: flat" color="#111"></a-plane>
      <a-sky color="#fee"></a-sky>
    </a-scene>
    <script>

     let lyrics = [
       {v: "Everybody!", p: "-9 1.3 -11", r: "0 0 0"},
       {v: "Rock your body!", p: "-2.6 1.3 -6", r: "0 -90 0"},
       {v: "Everybody!", p: "-5.8 2.3 -4.3", r: "0 90 0"},
       {v: "Rock your body!", p: "-3 3 -1.3", r: "0 -90 0"},
       {v: "Backstreet's back!", p: "-9 4 0.1", r: "0 0 0"},
       {v: "Oh my god, we're back again!", p: "-11.3 3 4.5", r: "0 90 0"},
       {v: "Brothers, sisters everybody sing!", p: "-9.8 3.4 10.1", r: "0 -180 0"},
       {v: "Gonna bring the flavor, show you how!", p: "-6.1 2 8", r: "0 -90 0"},
       {v: "Got a question for you better answer now!", p: "-3.4 2.8 5.8", r: "0 -180 0"},
       {v: "Am I original?", p: "-0.1 1.3 5.9", r: "0 180 0"},
       {v: "Am I the only one?", p: "0 2.3 2.6", r: "0 0 0"},
       {v: "Am I sexual?", p: "3.3 3.1 2.6", r: "0 0 0"},
       {v: "Am I everything you need?", p: "4.8 3.3 10.4", r: "0 180 0"},
       {v: "You better rock your body now!", p: "10.4 1.4 6.4", r: "0 -90 0"},
       {v: "Everybody!", p: "10.4 1.4 0", r: "0 -90 0"},
       {v: "Rock your body!", p: "7.3 4.4 -4.7", r: "0 0 0"},
       {v: "Everybody!", p: "3.6 2.7 -2.7", r: "0 180 0"},
       {v: "Rock your body right!", p: "-1.2 1.3 -6.6", r: "0 90 0"},
       {v: "Backstreet's back!", p: "1.9 2.8 -8.8", r: "0 -90 0"},
       {v: "Alright!", p: "-1 2.2 -11", r: "0 90 0"}
     ]

     let scene = document.getElementById('mainscene');
     lyrics.forEach((v,i) => {
       let e = document.createElement('a-entity');
       e.classList.add('lyric');
       e.setAttribute('geometry','primitive: plane; width: 4; height: 1;');
       e.setAttribute('material', 'color: grey');
       e.setAttribute('text', `value: ${v.v}; width=: 6; height: 2; align: center; font: monoid;`);
       e.setAttribute('rotation', v.r);
       e.setAttribute('position', v.p);
       e.setAttribute("cursor-listener", true);
       e.setAttribute('animation', 'property: scale; from: 0.7 0.7 0.7; to: 0.9 0.9 0.9; loop: true; dir: alternate; dur: 800;');
       scene.appendChild(e);
     })

    </script>
  </body>
</html>
