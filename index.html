<html>
  <head>
    <!-- <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script> -->
    <script src="a-frame-dev.js"></script>

    <script src="TinyMusic.js"></script>
    <script>
     // game state
     window.state = {
       current: 1,
       speed: 0.01,
       score: 0,
       mode: 'title',
       checkpoints: []
     }

     fetch('checkpoints.txt')
       .then((data) => data.json())
       .then((data) => {
         window.state.checkpoints = JSON.parse(data);
       })


     AFRAME.registerShader('brix', {
       schema: {},
       vertexShader: `
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
       `,
       fragmentShader: `
varying vec2 vUv;

void main() {
  float single = (mod(vUv[0], 0.09) * 60.0) * mod(vUv[1], 0.06) * 100.0;
  vec3 construct = vec3(single);

  construct.b = 0.3 * construct.r;
  construct.g = 0.3 * construct.r;

  gl_FragColor = vec4(construct, 1.0);
  //gl_FragColor = vec4(0.4, 0.2, 0.2, 1.0);
}
       `
     });

     AFRAME.registerComponent('cursor-listener', {
       init: function () {
         // Prep the speech synthesis voice
         var synth = window.speechSynthesis;
         var voice = synth.getVoices()[2];
         var otherVoice = synth.getVoices()[1];

         this.el.addEventListener('click', function (evt) {
           if (window.state.mode === 'play') {
             console.log(window.state)
             this.setAttribute('material', 'color', 'white');
             var utterThis = new SpeechSynthesisUtterance(this.getAttribute('text')['value']);
             utterThis.voice = voice;
             synth.speak(utterThis);
           }
         });

         this.el.addEventListener('animationcomplete', function (evt) {
           if (window.state.mode === 'play' ) {
             this.remove();
             var utterPoint = new SpeechSynthesisUtterance('Yeeaaaaaahh!');
             utterPoint.voice = otherVoice;
             synth.speak(utterPoint);
             state.score ++;
             document.querySelector('#score-hud').setAttribute('text', 'value', `score ${state.score}`);
           }
         });
       }
     });

     AFRAME.registerComponent('player-auto-move', {
       schema: {},
       init: function () {
         console.log('init player');
       },
       tick: function () {
         if (window.state.mode === 'play') {
           let current = window.state.checkpoints[state.current];

           if (current) {
             let checked = this.checkAxis(current);
             if (checked) {
               window.state.current += 1;
             }
           } else {
             window.state.mode = 'end';
             console.log("ALRIGHT")
           }
         }
       },

       checkAxis: function (current) {
         let axis = current.a;
         let pos = current.p;
         let player_ax = this.el.object3D.position[axis];
         let goal_ax = pos[axis];

         if (player_ax <= goal_ax) {
           this.el.object3D.position[axis] += state.speed;
         } else if (player_ax >= goal_ax) {
           this.el.object3D.position[axis] -= state.speed;
         }

         if (this.el.object3D.position[axis].toFixed(2) == goal_ax) {
           return true;
         } else {
           return false;
         }
       }
     });


     AFRAME.registerComponent('scene-play-music', {
       schema: {},
       init: function() {
         // TinyMusic action!
         var ac = new AudioContext();
         var tempo = 120;

         // https://tabs.ultimate-guitar.com/tab/backstreet_boys/everybody_backstreets_back_tabs_2427811
         // rests are gut feeling ¯\_(ツ)_/¯
         var sequence = new TinyMusic.Sequence( ac, tempo, [
           'B3 e',
           '- e',
           'B3 e',
           'A#3 e',
           'A3 e',
           'G#3 e',
           'G3 e',
           '- e',
           'G3 e',
           '- e',
           'G3 e',
           'A3 e',
           'F#3 e',
           '- h'
         ]);

         sequence.waveType = 'sine';
         sequence.staccato = 0.05;
         sequence.bass.gain.value = 30;
         sequence.mid.gain.value = 5;
         sequence.loop = true ;
         sequence.gain.gain.value =  0.2;
         sequence.play(); // and never stop!
       }

     });

    </script>
  </head>
  <body>
    <a-scene scene-play-music>
      <a-entity id="walls" position="0 0 0">
        <a-entity  position="-8 4 -12" geometry="primitive: box; width: 13; height: 8" material="shader: brix"></a-entity>
        <a-entity  position="-2 4 -8" geometry="primitive: box; width: 15; height: 8" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-12 7 -4" geometry="width: 8; height: 15; depth: 12" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-12 4 4" geometry="width: 15; height: 8" rotation="0 -90 0" material="shader: brix"></a-entity>
        <a-entity position="-5 4 11" geometry="width: 15; height: 8" rotation="" material="shader: brix"></a-entity>
        <a-entity position="-2 10.85 12" geometry="width: 8; height: 22; depth: 12" rotation="" material="shader: brix"></a-entity>
        <a-entity position="4 4 11" geometry="width: 15; height: 8" rotation="" material="shader: brix"></a-entity>
        <a-entity position="1.4 6 0" geometry="width: 8; height: 14; depth: 5" rotation="" material="shader: brix"></a-entity>
        <a-entity position="11 4 0" geometry="width: 23; height: 8" rotation="0 90 0" material="shader: brix"></a-entity>
        <a-entity position="7 10 -11" geometry="width: 10; height: 22; depth: 12" rotation="" material="shader: brix"></a-entity>
      </a-entity>


      <a-entity cursor-listener
                animation="property: rotation; to: 0 0 180; dur: 1000; startEvents: click;"
                geometry="primitive: plane; width: 2; height: 1;"
                material="color: grey"
                text="value: Everybody!; width: 6; height: 2; align: center; font: monoid;" rotation="0 -90 0"
                position="-12 1.6 -10"></a-entity>

      <a-entity cursor-listener
                animation="property: rotation; to: 0 0 180; dur: 1000; startEvents: click;"
                geometry="primitive: plane; width: 2; height: 1;"
                material="color: grey"
                text="value: Rock your body!; width: 6; height: 2; align: center; font: monoid;"
                rotation="0 -90 0"
                position="-10 1.6 -10"></a-entity>

      <a-entity cursor-listener
                animation="property: rotation; to: 0 0 180; dur: 1000; startEvents: click;"
                geometry="primitive: plane; width: 2; height: 1;"
                material="color: grey"
                text="value: Everybody!; width: 6; height: 2; align: center; font: monoid;" rotation="0 -90 0"
                position="-9 1.6 -10"></a-entity>

      <a-entity position="-14 1.6 -10" rotation="0 -90 0" id="player" player-auto-move>
        <a-entity camera look-controls >
          <a-entity id="score-hud"
                    text="value: score 0; width: 2; height: 1; font: monoid; align: right; color: #333" position="0.0 0.5 -0.7" rotation="0 0 0"></a-entity>
          <a-entity cursor="fuse: true; fuseTimeout: 500"
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: black; shader: flat"></a-entity>
        </a-entity>
      </a-entity>

      <a-plane id="floor" position="0 0 0" rotation="-90 0 0" width="30" height="30" material="shader: flat" color="#111"></a-plane>
      <a-sky color="#fee"></a-sky>
    </a-scene>
  </body>
</html>
